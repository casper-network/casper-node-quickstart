---
AWSTemplateFormatVersion: 2010-09-09
Description: >-
  Creates a single instance Autoscaling Group running a
  Casper Node.

Parameters:

  Identifier:
    Type: String
    Description: A name identifier for the resources

  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC where the instance should be deployed to

  SubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: Choose which subnets the nodes should be deployed to

  InstanceType:
    Type: String
    Default: r5.large
    Description: Instance type for the nodes

  EbsVolumeSize:
    Type: Number
    Default: 250
    Description: Size of the EBS volume of the instances in GB

  AmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/canonical/ubuntu/server/20.04/stable/current/amd64/hvm/ebs-gp2/ami-id
    Description: Parameter Store path for the AMI Id

  KeyName:
    Type: String
    Default: ''
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instances. Leave blank to disable SSH access.

  IpWhitelist:
    Type: String
    Default: ''
    Description: IP to allow SSH access to the node. Used only if SSH access is enabled.

  #  ############## Service #############

  NetworkName:
    Type: String
    Description: Name of the network

  NetworkIp:
    Type: String
    Description: IP of the network

  CustomInitScript:
    Type: String
    Default: ''
    Description: A custom script to execute before the node initialization.

  #  ############### Tags ###############

  OwnerName:
    Type: String
    Description: An arbitrary tag name for the owner of these resources

  ProjectName:
    Type: String
    Description: The name of the project to which these resources belong

  Environment:
    Type: String
    Description: Environment name to append to resources names and tags
      
Conditions:

  Never: !Equals [ true, false ]

  EnableSSH: !Not [ !Equals [ !Ref KeyName, '' ] ]

Resources:

  NullResource:
    Type: Custom::NullResource
    Condition: Never

  InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      Path: /
      RoleName: !Sub ${Identifier}-${AWS::Region}-node
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement: 
        - Effect: Allow
          Principal: 
            Service: 
            - ec2.amazonaws.com
          Action: 
          - sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM
      - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy

  InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
      - !Ref InstanceRole

  # ########## Security Groups #########

  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId: !Ref VpcId
      GroupName: !Sub ${Identifier}-node
      GroupDescription: !Sub Security group for ${Identifier} nodes
      SecurityGroupIngress:
      - !If [ EnableSSH, { IpProtocol: tcp, CidrIp: !Ref IpWhitelist, FromPort: 22, ToPort: 22 }, !Ref 'AWS::NoValue' ] 
      - { IpProtocol: tcp, CidrIp: "0.0.0.0/0", FromPort: 7777, ToPort: 7777 }
      - { IpProtocol: tcp, CidrIp: "0.0.0.0/0", FromPort: 8888, ToPort: 8888 }
      - { IpProtocol: tcp, CidrIp: "0.0.0.0/0", FromPort: 9999, ToPort: 9999 }
      - { IpProtocol: tcp, CidrIp: "0.0.0.0/0", FromPort: 35000, ToPort: 35000 }
      SecurityGroupEgress:
      - { IpProtocol: -1, CidrIp: "0.0.0.0/0" }
      Tags:
      - Key: Name
        Value: !Sub ${Identifier}-node
      - Key: Owner
        Value: !Ref OwnerName
      - Key: ProjectName
        Value: !Ref ProjectName
      - Key: Environment
        Value: !Ref Environment

  LogGroup:
    Type: AWS::Logs::LogGroup
    Properties: 
      LogGroupName: !Sub /${Identifier}
      RetentionInDays: 3

  LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub ${Identifier}-node
      LaunchTemplateData:
        ImageId: !Ref AmiId
        KeyName: !If [ EnableSSH, !Ref KeyName, !Ref 'AWS::NoValue' ]
        InstanceType: !Ref InstanceType
        BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: !Ref EbsVolumeSize
        SecurityGroupIds: 
        - !Ref SecurityGroup
        IamInstanceProfile: 
          Arn: !GetAtt InstanceProfile.Arn
        Monitoring: 
          Enabled: true
        TagSpecifications: 
        - ResourceType: instance
          Tags: 
          - Key: Name
            Value: !Sub ${Identifier}-node
          - Key: Owner
            Value: !Ref OwnerName
          - Key: ProjectName
            Value: !Ref ProjectName
          - Key: Environment
            Value: !Ref Environment
          - Key: Datadog
            Value: false
        UserData:
          Fn::Base64: !Sub |
            #cloud-config
            repo_update: true
            repo_upgrade: all

            packages:
            - jq

            write_files:
            - path: /tmp/custom-init-script.sh
              permissions: 0777
              content: "${CustomInitScript}"
            - path: /tmp/install-casper-node-launcher.sh
              permissions: 0777
              content: |
                #!/bin/bash -x
                casperNodeLauncherVersion=${!1}
                casperClientVersion=${!2}

                curl -JLO https://bintray.com/casperlabs/debian/download_file?file_path=casper-client_0.9.3-0_amd64.deb
                curl -JLO https://bintray.com/casperlabs/debian/download_file?file_path=casper-node-launcher_0.3.1-0_amd64.deb
                apt install -y ./casper-client_0.9.3-0_amd64.deb ./casper-node-launcher_0.3.1-0_amd64.deb
                sudo -u casper /etc/casper/pull_casper_node_version.sh 1_0_0 ${NetworkName}
                sudo -u casper /etc/casper/config_from_example.sh 1_0_0
                sed -i "/trusted_hash =/c\trusted_hash = '$(curl -s ${NetworkIp}:8888/status | jq -r .last_added_block_info.hash | tr -d '\n')'" /etc/casper/1_0_0/config.toml
                sudo -u casper casper-client keygen /etc/casper/validator_keys;
                logrotate -f /etc/logrotate.d/casper-node; sleep 5
                systemctl start casper-node-launcher; sleep 5
                systemctl status casper-node-launcher || true

            - path: /tmp/install-cloudwatch-agent.sh
              permissions: 0777
              content: |
                #!/bin/bash -x

                wget https://s3.amazonaws.com/amazoncloudwatch-agent/debian/amd64/latest/amazon-cloudwatch-agent.deb
                dpkg -i -E ./amazon-cloudwatch-agent.deb
                /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json -s

            - path: /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
              permissions: 0444
              content: |
                {
                  "agent": {
                    "debug": true
                  },
                  "logs": {
                    "logs_collected": {
                      "files": {
                        "collect_list": [{
                          "log_group_name": "${LogGroup}",
                          "file_path": "/var/log/casper/casper-node.log",
                          "log_stream_name": "{instance_id}/var/log/casper/casper-node.log",
                          "timestamp_format": "%Y-%m-%dT%H:%M:%S"
                        }]
                      }
                    }
                  },
                  "metrics": {
                    "append_dimensions": {
                      "AutoScalingGroupName": "${!aws:AutoScalingGroupName}"
                    },
                    "metrics_collected": {
                      "mem": {
                        "measurement": [
                          "mem_used_percent"
                        ]
                      },
                      "disk": {
                        "measurement": [
                          "disk_used_percent"
                        ]
                      },
                      "swap": {
                        "measurement": [
                          "swap_used_percent"
                        ]
                      }
                    }
                  }
                }

            runcmd:
            - apt-get -y install python-setuptools
            - wget https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-py3-latest.tar.gz
            - python3 -m easy_install --script-dir /opt/aws/bin aws-cfn-bootstrap-py3-latest.tar.gz
            - /tmp/install-cloudwatch-agent.sh
            - /tmp/custom-init-script.sh
            - /tmp/install-casper-node-launcher.sh 0.9.3 0.3.1
            - /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource AutoScalingGroup --region ${AWS::Region}


  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    CreationPolicy:
      ResourceSignal:
        Count: 1
        Timeout: PT5M
    Properties:
      AutoScalingGroupName: !Sub ${Identifier}
      VPCZoneIdentifier: !Ref SubnetIds
      MinSize: 1
      MaxSize: 1
      DesiredCapacity: 1
      MixedInstancesPolicy:
        InstancesDistribution: 
          OnDemandAllocationStrategy: prioritized
          OnDemandBaseCapacity: 0
          OnDemandPercentageAboveBaseCapacity: 100
          SpotAllocationStrategy: capacity-optimized
          SpotMaxPrice: !Ref AWS::NoValue
        LaunchTemplate: 
          LaunchTemplateSpecification: 
            LaunchTemplateId: !Ref LaunchTemplate
            Version: !GetAtt LaunchTemplate.LatestVersionNumber
          Overrides: 
          - InstanceType: !Ref InstanceType
      MetricsCollection:
      - Granularity: 1Minute
        Metrics:
        - GroupMinSize
        - GroupMaxSize
        - GroupDesiredCapacity
        - GroupInServiceInstances
        - GroupPendingInstances
        - GroupStandbyInstances
        - GroupTerminatingInstances
        - GroupTotalInstances
      Tags:
      - Key: Name
        Value: !Sub ${Identifier}
        PropagateAtLaunch: true
      - Key: Owner
        Value: !Ref OwnerName
        PropagateAtLaunch: true
      - Key: ProjectName
        Value: !Ref ProjectName
        PropagateAtLaunch: true
      - Key: Environment
        Value: !Ref Environment
        PropagateAtLaunch: true

  Dashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties: 
      DashboardName: !Sub ${Identifier}
      DashboardBody: !Sub |
        {
            "widgets": [
                {
                    "height": 6,
                    "width": 6,
                    "y": 3,
                    "x": 12,
                    "type": "metric",
                    "properties": {
                        "view": "timeSeries",
                        "stacked": false,
                        "metrics": [
                            [ "AWS/EC2", "CPUUtilization", "AutoScalingGroupName", "${AutoScalingGroup}" ]
                        ],
                        "region": "${AWS::Region}",
                        "period": 300,
                        "title": "CPU"
                    }
                },
                {
                    "height": 3,
                    "width": 12,
                    "y": 0,
                    "x": 0,
                    "type": "text",
                    "properties": {
                        "markdown": "\n# Casper Node \n&nbsp;\n\nAccess Node: [button:Session Manager](https://console.aws.amazon.com/systems-manager/session-manager/start-session?region=${AWS::Region}#)\n"
                    }
                },
                {
                    "height": 6,
                    "width": 6,
                    "y": 9,
                    "x": 12,
                    "type": "metric",
                    "properties": {
                        "view": "timeSeries",
                        "stacked": false,
                        "metrics": [
                            [ "AWS/EC2", "NetworkIn", "AutoScalingGroupName", "${AutoScalingGroup}" ],
                            [ ".", "NetworkOut", ".", "." ]
                        ],
                        "region": "${AWS::Region}",
                        "title": "Network"
                    }
                },
                {
                    "height": 6,
                    "width": 6,
                    "y": 9,
                    "x": 18,
                    "type": "metric",
                    "properties": {
                        "view": "timeSeries",
                        "stacked": false,
                        "metrics": [
                            [ "AWS/EC2", "EBSReadBytes", "AutoScalingGroupName", "${AutoScalingGroup}" ],
                            [ ".", "EBSWriteBytes", ".", "." ]
                        ],
                        "region": "${AWS::Region}",
                        "title": "Disk IO"
                    }
                },
                {
                    "height": 6,
                    "width": 6,
                    "y": 3,
                    "x": 18,
                    "type": "metric",
                    "properties": {
                        "view": "timeSeries",
                        "stacked": false,
                        "metrics": [
                            [ "CWAgent", "mem_used_percent", "AutoScalingGroupName", "${AutoScalingGroup}" ]
                        ],
                        "region": "${AWS::Region}",
                        "title": "Memory"
                    }
                },
                {
                    "type": "log",
                    "x": 0,
                    "y": 3,
                    "width": 12,
                    "height": 12,
                    "properties": {
                        "query": "SOURCE '${LogGroup}' | fields @timestamp, level, @message",
                        "region": "${AWS::Region}",
                        "title": "Logs",
                        "view": "table"
                    }
                },
                {
                    "type": "metric",
                    "x": 12,
                    "y": 0,
                    "width": 12,
                    "height": 3,
                    "properties": {
                        "metrics": [
                            [ "AWS/EC2", "StatusCheckFailed", "AutoScalingGroupName", "${AutoScalingGroup}" ],
                            [ ".", "StatusCheckFailed_System", ".", "." ],
                            [ ".", "StatusCheckFailed_Instance", ".", "." ]
                        ],
                        "view": "singleValue",
                        "region": "${AWS::Region}",
                        "title": "Instance Checks",
                        "period": 300,
                        "stat": "Average"
                    }
                }
            ]
        }

Outputs:

  SecurityGroup:
    Description: Security group of the node
    Value: !Ref SecurityGroup
    
  AutoScalingGroupName:
    Description: Name of the AutoScaling Group    
    Value: !Ref AutoScalingGroup

  DashboardName:
    Description: CloudWatch Dashboard name
    Value: !Ref Dashboard
  
  DashboardUrl:
    Description: CloudWatch Dashboard URL
    Value: !Sub https://${AWS::Region}.console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=${Dashboard}